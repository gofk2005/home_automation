# Общая информация

Система обнаружения людей на кадрах из видеопотока. Источником видео может быть как локальная камера (например, USB Webcam), так и IP-камера.
Параметризована большая часть настроек: интервалы фиксации изображения, используемая библиотека, использование видеокарты и др. Список параметров ниже.
Используются библиотеки: OpenCV, cvlib, TensorFlow, сеть YOLO4.

При запуске скрипта через заданный интервал времени (параметр **period**) кадр входного видеопотока обрабатывается, алгоритм определяет наличие на изображении людей. Изображение сохраняется на жесткий диск в виде отдельного файла. Если состояние (наличие людей) изменилось по отношению к предыдущему состоянию - информация о наличии людей передается на MQTT-брокер как значение дискретного датчика.
Дополнительно через заданный интервал времени (параметр **send_interval**) на MQTT-брокер передается текущее состояние датчика и информация, необходимая для корректной работы модуля [MQTT Discovery (Home Assistant)](https://www.home-assistant.io/docs/mqtt/discovery/).

Основные этапы получения изображения, его обработки и передачи данных оформлены как отдельные функции. Это позволяет без труда модифицировать скрипт под текущие нужды

# Список файлов:

**detect.py** - основная версия скрипта

**detect_docker.py** - версия скрипта, которая используется в docker-контейнере

**Dockerfile** - использовался для создания образа https://hub.docker.com/repository/docker/gofk/presence_detect

**requirements.txt** - библиотеки, необходимые при сборке образа

# Параметры запуска скрипта **detect.py**

**source** - источник видео. Если указано число - считается, что это идентификатор локальной камеры. Если введена строка - считается, что это адрес потока от IP-камеры. Значение по умолчанию = 0.

**period** - интервал получения изображения (frame) с камеры в секундах. Значение по умолчанию = 30.

**send_interval** - период отправки данных на сервер в секундах. По умолчанию данные передаются только в случае, когда состояние изменилось (людей на изображении не было, а потом они появились или наоборот). Данный параметр задает период, по истечении которого данные будут переданы в любом случае. Дополнительно передается информация для модуля [MQTT Discovery (Home Assistant)](https://www.home-assistant.io/docs/mqtt/discovery/). Значение по умолчанию = 300.

**device_id** - уникальный идентификатор устройства, нужен для идентификации на сервере. Значение по умолчанию = 0.

**mqtt_brocker_ip** - адрес MQTT-брокера. Значение по умолчанию = "127.0.0.1".

**mqtt_brocker_port** - порт MQTT-брокера. Значение по умолчанию = "1883".

**dont_use_mqtt** - значение не указывается, достаточно наличия параметра. Если параметр задан - отправка данных производиться не будет. Данные MQTT-брокера (выше) в этом случае игнорируются. По умолчанию отправка данных активна.

**dont_save_img_to_disk** - значение не указывается, достаточно наличия параметра. Если параметр задан - изображения не будут сохраняться на жесткий диск после обработки. По умолчанию автоматически создается папка /img/ рядом со скриптом, в ней создаются папки, имена которых совпадают с текущей датой. В этих папках сохраняются изображения.

**tiny_yolo** - значение не указывается, достаточно наличия параметра. Если параметр задан - используется версия yolov4-tiny (менее точная, но при этом менее требовательная к ресурсам). По умолчанию используется yolov4.

**confidence** - минимальный "процент уверенности", при котором фиксируется обнаружение людей на изображении. Допустимый интервал: целое число от 1 до 100. Значение по умолчанию: 65.

**gpu** - значение не указывается, достаточно наличия параметра. Пытаться ли использовать GPU для работы. По умолчанию GPU не используется.

# Дополнительно

Docker-образ, собранный на основе скрипта **detect_docker.py**, можно найти здесь: https://hub.docker.com/repository/docker/gofk/presence_detect. Образ собран с использованием **Dockerfile**.
Там же подробно описаны параметры и переменные окружения, которые можно использовать при старте контейнера.

# Контакты

Все вопросы, предложения и замечания по работе скрипта вы всегда можете направить автору по почте: gofk2005@yandex.ru.
Система GIT позволяет оформлять замечания в виде отдельных Issue. Не забываем про эту возможность.
Любые доработки и конструктивная критика категорически приветствуются. 
Канал на youtube: https://www.youtube.com/channel/UCUh89-ti4wwvwrm8nCZkz8Q
Страничка VK: https://vk.com/id530811716
Канал в Telegram: https://t.me/hautomation